#!/bin/bash
set -e

# ─────────────────────────────────────────────────────────────
# Colors & helpers
# ─────────────────────────────────────────────────────────────
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

info() {
    echo -e "${GREEN}== $1 ==${NC}"
}

error() {
    echo -e "${RED}== $1 ==${NC}"
}

# ─────────────────────────────────────────────────────────────
# Versions (LOCK THESE)
# ─────────────────────────────────────────────────────────────
SPARK_SCALA_VERSION=2.12
SPARK_MAJOR_VERSION=3.5
ICEBERG_VERSION=1.4.2
AWS_SDK_BUNDLE_VERSION=1.11.1026

DOWNLOAD_DIR="./downloads"

# ─────────────────────────────────────────────────────────────
# Downloads
# ─────────────────────────────────────────────────────────────

download_iceberg() {    
    info "Downloading Iceberg Spark runtime..."

    mkdir -p "${DOWNLOAD_DIR}"

    ICEBERG_JAR="iceberg-spark-runtime-${SPARK_MAJOR_VERSION}_${SPARK_SCALA_VERSION}-${ICEBERG_VERSION}.jar"
    ICEBERG_URL="https://repo1.maven.org/maven2/org/apache/iceberg/iceberg-spark-runtime-${SPARK_MAJOR_VERSION}_${SPARK_SCALA_VERSION}/${ICEBERG_VERSION}/iceberg-spark-runtime-${SPARK_MAJOR_VERSION}_${SPARK_SCALA_VERSION}-${ICEBERG_VERSION}.jar"
    ICEBERG_PATH="${DOWNLOAD_DIR}/${ICEBERG_JAR}"

    if [ ! -f "${ICEBERG_PATH}" ]; then
        wget -O "${ICEBERG_PATH}" "${ICEBERG_URL}" || {
            error "Failed to download Iceberg runtime JAR"
            exit 1
        }
    else
        info "Iceberg JAR already present, skipping"
    fi
}

download_aws_sdk_bundle() {
    info "Downloading AWS SDK bundle..."

    mkdir -p "${DOWNLOAD_DIR}"

    AWS_JAR="aws-java-sdk-bundle-${AWS_SDK_BUNDLE_VERSION}.jar"
    AWS_URL="https://repo1.maven.org/maven2/com/amazonaws/aws-java-sdk-bundle/${AWS_SDK_BUNDLE_VERSION}/${AWS_JAR}"
    AWS_PATH="${DOWNLOAD_DIR}/${AWS_JAR}"

    if [ ! -f "${AWS_PATH}" ]; then
        wget -O "${AWS_PATH}" "${AWS_URL}" || {
            error "Failed to download AWS SDK bundle"
            exit 1
        }
    else
        info "AWS SDK bundle already present, skipping"
    fi
}

# ─────────────────────────────────────────────────────────────
# MinIO
# ─────────────────────────────────────────────────────────────

install_minio() {
    info "Deploying MinIO..."
    kubectl apply -f deployments/minio-deployment.yaml

    info "Waiting for MinIO to be ready..."
    kubectl wait \
        --for=condition=ready pod \
        -l app=minio \
        --timeout=120s
}

reset_minio() {
    info "Resetting MinIO..."
    kubectl apply -f deployments/minio-reset-job.yaml

    kubectl wait \
        --for=condition=complete \
        job/minio-reset-job \
        --timeout=120s
}

# ─────────────────────────────────────────────────────────────
# Spark / Jupyter
# ─────────────────────────────────────────────────────────────

build_docker_image() {
    info "Building Spark + Jupyter + Iceberg image..."
    docker build --no-cache -t spark-jupyter-iceberg:latest .
}

deploy_spark() {
    info "Deploying Spark Jupyter stack..."
    kubectl apply -f deployments/spark-jupyter-standalone.yaml

    info "Waiting for Spark pod to be ready..."
    kubectl wait \
        --for=condition=ready pod \
        -l app=spark-jupyter-combined \
        --timeout=120s
}

# ─────────────────────────────────────────────────────────────
# Entry point
# ─────────────────────────────────────────────────────────────

case "$1" in
    download)
        download_iceberg
        download_aws_sdk_bundle
        ;;
    install)
        download_iceberg
        download_aws_sdk_bundle
        install_minio
        build_docker_image
        deploy_spark
        ;;
    reset-minio)
        reset_minio
        ;;
    *)
        error "Usage: $0 {download|install|reset-minio}"
        echo
        echo "  download     Download Iceberg + AWS SDK jars"
        echo "  install      Build image and deploy full stack"
        echo "  reset-minio  Wipe MinIO warehouse data"
        exit 1
        ;;
esac
